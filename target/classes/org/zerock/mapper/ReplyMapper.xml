<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace = "org.zerock.mapper.ReplyMapper">

<insert id = "insert">
	insert into review (review_comment, review_score, order_code, product_code, customer_code) 
	values (#{review_comment}, #{review_score}, #{order_code}, #{product_code}, #{customer_code})
</insert>

<select id = "read" resultType = "org.zerock.domain.ReplyVO">
	select r.review_code, r.review_date, r.review_comment, r.review_score, r.order_code, r.product_code, r.customer_code, c.customer_name
	from review as r join customer as c
	on r.customer_code = c.customer_code
	where r.review_code = #{review_code}
</select>

<delete id = "delete">
	delete from review where review_code = #{review_code}
</delete>

<update id = "update">
	update review set review_comment = #{review_comment}, review_score = #{review_score} where review_code = #{review_code}
</update>

<!--product_code @param("customer_id") int customer_id 와 연결 -->
<select id = "getListWIthPaging" resultType = "org.zerock.domain.ReplyVO">
	<![CDATA[
		select r.review_code, r.review_date, r.review_comment, r.review_score, r.order_code, r.product_code, r.customer_code, c.customer_name 
		from review as r join customer as c 
		on r.customer_code = c.customer_code 
		where r.product_code = #{product_code} and r.review_code > (#{cri.pageNum}-1) * #{cri.amount} and r.review_code <= #{cri.pageNum} * #{cri.amount}
	]]>
</select>

<select id = "getCountByProductCode" resultType = "int">
	<![CDATA[
		select count(review_code) from review where product_code = #{product_code}
	]]>
</select>

<select id = "CustomerReply" resultType = "int" parameterType = "HashMap">
	select exists (select customer_code from (select customer_code from order_basket where product_code = #{product_code}) t
	 where customer_code = #{customer_code})
</select>

<select id = "OrderStatusIsDone" resultType = "int" parameterType = "HashMap">
	select exists (select o.order_status
	from `order` as o join (select order_code from order_basket where product_code = #{product_code} and customer_code = #{customer_code}) as a 
	on o.order_code = a.order_code
	where o.order_status = "done")
</select>

<select id = "getOrderCode" resultType = "int">
	select o.order_code
	from `order` as o join (select order_code from order_basket where product_code = #{product_code} and customer_code = #{customer_code}) as a 
	on o.order_code = a.order_code
	where o.order_status = "done" order by o.order_code desc limit 1;
</select>
</mapper>